<!DOCTYPE html>
<html>
  <head>
    <title>Chat Bot</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .chat-container {
        max-width: 600px;
        margin: 0 auto;
      }
      .chat-input-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      input {
        flex: 1;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      button:hover:enabled {
        background-color: #0056b3;
      }
      .messages {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        height: 400px;
        overflow-y: auto;
        margin-bottom: 10px;
        background: #fff;
      }
      .message {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 8px;
      }
      .message.user {
        background-color: #e3f2fd;
        flex-direction: row-reverse;
      }
      .message.robot {
        background-color: #f5f5f5;
      }
      .message img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }
      .message span {
        word-break: break-word;
        max-width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="js-container"></div>

    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>
    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>
    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script src="https://unpkg.com/supersimpledev/dayjs.js"></script>

    <script type="text/babel">
      function ChatInput({ chatMessages, setChatMessages }) {
        const [inputText, setInputText] = React.useState("");
        const [isLoading, setIsLoading] = React.useState(false);

        function saveInputText(e) {
          setInputText(e.target.value);
        }

        async function sendMessage() {
          if (isLoading) return;
          const text = inputText.trim();
          if (!text) return;

          setIsLoading(true);

          // Add user message immediately
          const userMsg = {
            message: text,
            sender: "user",
            id: Date.now() + Math.random(),
          };
          setChatMessages((prev) => [...prev, userMsg]);
          setInputText("");

          try {
            // await async response (Chatbot.getResponseAsync provided by chatbot.js)
            const response = await Chatbot.getResponseAsync(text);
            const botMsg = {
              message: response || "Sorry, I didn't understand that.",
              sender: "robot",
              id: Date.now() + Math.random(),
            };
            setChatMessages((prev) => [...prev, botMsg]);
          } catch (err) {
            console.error("Chatbot error:", err);
            const errMsg = {
              message: "Error: Unable to get response. Please try again.",
              sender: "robot",
              id: Date.now() + Math.random(),
            };
            setChatMessages((prev) => [...prev, errMsg]);
          } finally {
            setIsLoading(false);
          }
        }

        return (
          <div className="chat-input-container">
            <input
              type="text"
              placeholder="Send a message to Chatbot.."
              value={inputText}
              onChange={saveInputText}
              onKeyDown={(e) => {
                if (e.key === "Enter") sendMessage();
                if (e.key === "Escape") setInputText("");
              }}
              disabled={isLoading}
            />
            <button
              onClick={sendMessage}
              disabled={isLoading || !inputText.trim()}
              aria-disabled={isLoading || !inputText.trim()}
            >
              {isLoading ? "Sending..." : "Send"}
            </button>
          </div>
        );
      }

      function ChatMessage({ message, sender }) {
        return (
          <div className={`message ${sender}`}>
            {sender === "robot" && (
              <img src="AI.jpg" width="50" alt="AI avatar" />
            )}
            <span>{message}</span>
            {sender === "user" && (
              <img src="BlankUser.jpg" width="50" alt="User avatar" />
            )}
          </div>
        );
      }

      function ChatMessages({ chatMessages }) {
        const endRef = React.useRef(null);

        React.useEffect(() => {
          endRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [chatMessages]);

        return (
          <div className="messages" role="log" aria-live="polite">
            {chatMessages.map((m) => (
              <ChatMessage
                key={m.id}
                message={m.message}
                sender={m.sender}
              />
            ))}
            <div ref={endRef} />
          </div>
        );
      }

      function App() {
        const [chatMessages, setChatMessages] = React.useState([
          { message: "Hello ChatBot", sender: "user", id: 1 },
          { message: "How can I help you?", sender: "robot", id: 2 },
        ]);

        return (
          <div className="chat-container" aria-label="Chat application">
            <ChatMessages chatMessages={chatMessages} />
            <ChatInput chatMessages={chatMessages} setChatMessages={setChatMessages} />
          </div>
        );
      }

      const container = document.querySelector(".js-container");
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>